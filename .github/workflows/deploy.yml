name: Deploy to Heroku

on:
  push:
    branches:
      - master  # or main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r api-server-flask/requirements.txt || echo "No requirements.txt file found"

    - name: Set Heroku environment variables
      env:
        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        DB_ENGINE: ${{ secrets.DB_ENGINE }}
        DB_USERNAME: ${{ secrets.DB_USERNAME }}
        DB_PASS: ${{ secrets.DB_PASS }}
        DB_HOST: ${{ secrets.DB_HOST }}
        DB_PORT: ${{ secrets.DB_PORT }}
        DB_NAME: ${{ secrets.DB_NAME }}
        USE_SQLITE: ${{ secrets.USE_SQLITE }}
        GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
        EMAIL_SERVER_PASSWORD: ${{ secrets.EMAIL_SERVER_PASSWORD }}
      run: |
        heroku config:set DB_ENGINE=$DB_ENGINE DB_USERNAME=$DB_USERNAME DB_PASS=$DB_PASS DB_HOST=$DB_HOST DB_PORT=$DB_PORT DB_NAME=$DB_NAME USE_SQLITE=$USE_SQLITE GOOGLE_MAPS_API_KEY=$GOOGLE_MAPS_API_KEY email_server_password=$EMAIL_SERVER_PASSWORD --app carpool-buddies

    - name: Deploy to Heroku
      env:
        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
        HEROKU_APP_NAME: carpool-buddies
      run: |
        git remote add heroku https://git.heroku.com/${{ env.HEROKU_APP_NAME }}.git
        git push heroku master  # Change to 'main' if your default branch is 'main'
